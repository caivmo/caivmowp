on: push
name: Deploy to Pantheon
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Obtiene todo el historial de Git

    - name: Set up PHP and Composer
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'  # Ajusta la versi√≥n si es necesario
        tools: composer

    - name: Install Dependencies
      run: composer install --no-dev --optimize-autoloader

    - name: Setup SSH
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.PANTHEON_SSH_KEY }}
        known_hosts: ${{ secrets.KNOWN_HOSTS }}

    - name: Set up Pantheon Git Remote
      env:
        pantheon_repo: ${{ vars.PANTHEON_REPO }}
      run: |
        git remote add pantheon $pantheon_repo || echo "Remote already exists"

    - name: Fetch and Rebase Changes
      run: |
        git fetch pantheon master
        git rebase pantheon/master || echo "No changes to rebase"

    - name: Push to Pantheon
      run: git push pantheon HEAD:master
