name: CI/CD Pipeline

on:
  push:
    branches: 
      - 'autopilot'
jobs:
  check-runner:
    name: Check Self-hosted Runner
    runs-on: ubuntu-latest
    outputs:
      runner_status: ${{ steps.check.outputs.runner_status }}
    steps:
      - name: Check runner status
        id: check
        env:
          GH_TOKEN: ${{ secrets.TOKEN_TEST }}
        run: |
          RUNNER_NAME="self-hosted"
          echo "🔍 Verificando estado del runner: $RUNNER_NAME"
          STATUS=$(gh api repos/${{ github.repository }}/actions/runners \
            --paginate \
            --jq ".runners[] | select(.name==\"$RUNNER_NAME\") | .status")

          if [ "$STATUS" = "online" ]; then
            echo "✅ Runner está online"
            echo "runner_status=online" >> "$GITHUB_OUTPUT"
          else
            echo "❌ Runner está offline"
            echo "runner_status=offline" >> "$GITHUB_OUTPUT"
          fi

  maybe-run-build:
    name: Build (only if runner is online)
    needs: check-runner
    if: needs.check-runner.outputs.runner_status == 'online'
    runs-on: [self-hosted]
    steps:
      - name: Run on self-hosted
        run: echo "🏃 Ejecutando en runner self-hosted"